<Page
    x:Class="Bangumi.Views.DetailsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:Bangumi.Views"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:data="using:Bangumi.Models"
    xmlns:common="using:Bangumi.Common"
    xmlns:sys="using:System"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    SizeChanged="Page_SizeChanged"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Grid Background="{ThemeResource SystemControlAcrylicWindowBrush}">
        <GridView Name="EpsGridView" 
                  ItemsSource="{x:Bind ViewModel.eps}" 
                  Padding="10,0,10,5">
            <GridView.Header>
                <StackPanel Orientation="Vertical" >
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Image Name="BangumiImage" 
                               Source="{x:Bind ViewModel.ImageSource, Mode=OneWay}"
                               Height="214" 
                               Width="150" />
                        <StackPanel Orientation="Vertical" 
                                    Grid.Column="1"
                                    Margin="10,0">
                            <TextBlock Name="NameTextBlock" 
                                       IsTextSelectionEnabled="True"
                                       Text="{x:Bind ViewModel.Name_cn, Mode=OneWay}"
                                       TextWrapping="Wrap"
                                       FontSize="23" 
                                       Foreground="#d26585" />
                            <TextBlock Name="air_dateTextBlock" 
                                       Text="{x:Bind sys:String.Format('开播时间：{0}',ViewModel.Air_date), Mode=OneWay}" 
                                       FontSize="15" 
                                       Foreground="#666666" 
                                       Margin="0,2,0,0" />
                            <TextBlock Name="air_weekdayTextBlock" 
                                       Text="{x:Bind sys:String.Format('更新时间：{0}',ViewModel.AirWeekdayName), Mode=OneWay}" 
                                       FontSize="15" 
                                       Foreground="#666666" 
                                       Margin="0,2,0,0" />
                            <StackPanel Orientation="Horizontal">
                                <Button Name="CollectionButton"
                                        IsEnabled="{x:Bind common:Converters.Not(ViewModel.IsCollectionStatusLoading), Mode=OneWay}"
                                        Foreground="#d26585"
                                        Background="{ThemeResource AppBarItemBackgroundThemeBrush}"
                                        Style="{StaticResource ButtonRevealStyle}">
                                    <Button.Flyout>
                                        <MenuFlyout>
                                            <MenuFlyoutItem Text="想看" 
                                                            Click="WishCollectionFlyoutItem_Click" />
                                            <MenuFlyoutItem Text="看过"
                                                            Click="WatchedCollectionFlyoutItem_Click"/>
                                            <MenuFlyoutItem Text="在看"
                                                            Click="DoingCollectionFlyoutItem_Click"/>
                                            <MenuFlyoutItem Text="搁置"
                                                            Click="OnHoldCollectionFlyoutItem_Click"/>
                                            <MenuFlyoutItem Text="抛弃"
                                                            Click="DropCollectionFlyoutItem_Click"/>
                                            <MenuFlyoutItem Text="删除"
                                                            Visibility="Collapsed"
                                                            Click="RemoveCollectionFlyoutItem_Click"/>
                                        </MenuFlyout>
                                    </Button.Flyout>
                                    <StackPanel Orientation="Horizontal">
                                        <FontIcon Name="CollectionButtonIcon" 
                                                  FontFamily="Segoe MDL2 Assets" 
                                                  Glyph="{x:Bind ViewModel.CollectionStatusIcon, Mode=OneWay}" 
                                                  Margin="0,0,5,0"/>
                                        <TextBlock Name="CollectionButtonText" 
                                                   Text="{x:Bind ViewModel.CollectionStatusText, Mode=OneWay}" />
                                    </StackPanel>
                                </Button>
                                <Button Name="CollectionAdvanceButton" 
                                        FontFamily="Segoe MDL2 Assets" 
                                        Background="{ThemeResource AppBarItemBackgroundThemeBrush}"
                                        Style="{StaticResource ButtonRevealStyle}"
                                        Click="CollectionAdvanceButton_Click"
                                        IsEnabled="{x:Bind common:Converters.Not(ViewModel.IsRateLoading), Mode=OneWay}"
                                        Margin="5,0,0,0">
                                    <FontIcon FontFamily="Segoe MDL2 Assets" 
                                              Glyph="&#xE70F;"/>
                                </Button>
                            </StackPanel>
                        </StackPanel>
                    </Grid>
                    <TextBlock Name="SummaryTextBlock" 
                               Text="{x:Bind ViewModel.Summary, Mode=OneWay}"
                               IsTextSelectionEnabled="True"
                               FontSize="18" 
                               TextWrapping="Wrap" 
                               LineHeight="30" 
                               Margin="0,5,0,0" />
                    <HyperlinkButton Name="MoreInfoHyperLink"
                                     Content="更多资料"
                                     Click="MoreInfoButton_Click"
                                     Visibility="{x:Bind common:Converters.CollapsedIf(ViewModel.IsDetailLoading), Mode=OneWay}"
                                     FontSize="16"
                                     Foreground="#d26585"/>
                </StackPanel>
            </GridView.Header>
            <GridView.ItemTemplate>
                <DataTemplate x:DataType="data:Ep">
                    <Grid Tapped="Eps_Tapped" 
                          RightTapped="Eps_RightTapped"
                          Padding="5" 
                          Height="68"
                          Width="{Binding ElementName=MyWidth,Path=Width}"
                          BorderThickness="0.5"
                          BorderBrush="{ThemeResource SystemControlBackgroundListMediumRevealBorderBrush}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <Grid>
                            <TextBlock Text="{x:Bind sort}" 
                                       FontSize="14" />
                            <TextBlock Grid.Column="1" 
                                       x:Phase="2"
                                       Text="{x:Bind status,Mode=OneWay}" 
                                       FontSize="12" 
                                       Foreground="#d26585"
                                       HorizontalAlignment="Right"/>
                        </Grid>
                        <TextBlock Grid.Row="1"
                                   x:Phase="1"
                                   Text="{x:Bind name_cn}" 
                                   FontSize="14" 
                                   HorizontalAlignment="Left"
                                   TextWrapping="Wrap"
                                   TextTrimming="WordEllipsis"/>

                        <FlyoutBase.AttachedFlyout>
                            <MenuFlyout>
                                <MenuFlyoutItem Click="WatchedMenuFlyoutItem_Click" 
                                                Text="看过"/>
                                <MenuFlyoutItem Click="WatchedToMenuFlyoutItem_Click" 
                                                IsEnabled="True" 
                                                Text="看到"/>
                                <MenuFlyoutItem Click="QueueMenuFlyoutItem_Click" 
                                                Text="想看"/>
                                <MenuFlyoutItem Click="DropMenuFlyoutItem_Click" 
                                                Text="抛弃"/>
                                <MenuFlyoutItem Click="RemoveMenuFlyoutItem_Click" 
                                                Text="未看"/>
                            </MenuFlyout>
                        </FlyoutBase.AttachedFlyout>
                    </Grid>
                </DataTemplate>
            </GridView.ItemTemplate>
        </GridView>

        <ProgressBar Name="MyProgressBar"
                     Visibility="{x:Bind ViewModel.IsUpdating, Mode=OneWay}"
                     IsIndeterminate="True"
                     VerticalAlignment="Top"/>
        <ProgressRing Name="MyProgressRing"
                      Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                      IsActive="True"
                      Width="50"
                      Height="50"/>

        <Border Name="MyWidth"
                            Visibility="Collapsed"/>

    </Grid>
</Page>
