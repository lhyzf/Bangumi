<Page
    x:Class="Bangumi.Views.DetailsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:Bangumi.Views"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:data="using:Bangumi.Models"
    xmlns:common="using:Bangumi.Common"
    xmlns:sys="using:System"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    NavigationCacheMode="Enabled"
    Loaded="Page_Loaded"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Page.Resources>
        <DataTemplate x:Name="EpTemplate" x:DataType="data:Ep">
            <Grid Tapped="Eps_Tapped" 
                    RightTapped="Eps_RightTapped"
                    Padding="5" 
                    Height="68"
                    Width="{Binding ElementName=MyWidth,Path=Width}"
                    Background="Transparent"
                    BorderThickness="0.5"
                    BorderBrush="{ThemeResource SystemControlBackgroundListMediumBrush}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <Grid>
                    <TextBlock Text="{x:Bind sort}" 
                                FontSize="14" />
                    <TextBlock Grid.Column="1" 
                                x:Phase="2"
                                Text="{x:Bind status,Mode=OneWay}" 
                                FontSize="12" 
                                Foreground="#d26585"
                                HorizontalAlignment="Right"/>
                </Grid>
                <TextBlock Grid.Row="1"
                            x:Phase="1"
                            Text="{x:Bind name_cn}" 
                            FontSize="14" 
                            HorizontalAlignment="Left"
                            TextWrapping="Wrap"
                            TextTrimming="WordEllipsis"/>

                <FlyoutBase.AttachedFlyout>
                    <MenuFlyout>
                        <MenuFlyoutItem Click="WatchedMenuFlyoutItem_Click" 
                                        Text="看过"/>
                        <MenuFlyoutItem Click="WatchedToMenuFlyoutItem_Click" 
                                        IsEnabled="True" 
                                        Text="看到"/>
                        <MenuFlyoutItem Click="QueueMenuFlyoutItem_Click" 
                                        Text="想看"/>
                        <MenuFlyoutItem Click="DropMenuFlyoutItem_Click" 
                                        Text="抛弃"/>
                        <MenuFlyoutItem Click="RemoveMenuFlyoutItem_Click" 
                                        Text="未看"/>
                    </MenuFlyout>
                </FlyoutBase.AttachedFlyout>
            </Grid>
        </DataTemplate>
    </Page.Resources>
    
    <Grid>
        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup>
                <VisualState x:Name="Narrow">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="0"/>
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="BangumiImage.Width" Value="75"/>
                        <Setter Target="BangumiImage.Height" Value="107"/>
                        <Setter Target="NameTextBlock.FontSize" Value="16"/>
                        <Setter Target="air_dateTextBlock.FontSize" Value="14"/>
                        <Setter Target="air_weekdayTextBlock.FontSize" Value="14"/>
                        <Setter Target="SummaryTextBlock.FontSize" Value="14"/>
                    </VisualState.Setters>
                </VisualState>
                <VisualState x:Name="Wide">
                    <VisualState.StateTriggers>
                        <AdaptiveTrigger MinWindowWidth="400" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="BangumiImage.Width" Value="150"/>
                        <Setter Target="BangumiImage.Height" Value="214"/>
                        <Setter Target="NameTextBlock.FontSize" Value="24"/>
                        <Setter Target="air_dateTextBlock.FontSize" Value="16"/>
                        <Setter Target="air_weekdayTextBlock.FontSize" Value="16"/>
                        <Setter Target="SummaryTextBlock.FontSize" Value="18"/>
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>
        <Grid.RowDefinitions>
            <RowDefinition Height="32"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <Grid Grid.Row="0" 
              Height="32"
              Name="GridTitleBar"
              Background="Transparent">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="auto"/>
            </Grid.ColumnDefinitions>
            <TextBlock Text="{x:Bind ViewModel.Name_cn,Mode=OneWay}" 
                       Grid.Column="0"
                       VerticalAlignment="Center"  
                       Margin="10,0"
                       TextTrimming="CharacterEllipsis"/>
            <ProgressRing Name="MyProgressRing"
                          Grid.Column="1"
                          Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                          VerticalAlignment="Center"
                          IsActive="True"
                          Width="20"
                          Height="20" >
                <ProgressRing.RenderTransform>
                    <CompositeTransform CenterX="10"
                                        CenterY="10"
                                        ScaleX="0.75" 
                                        ScaleY="0.75"/>
                </ProgressRing.RenderTransform>
            </ProgressRing>
        </Grid>
        <GridView Name="EpsGridView" 
                  Grid.Row="1"
                  ItemsSource="{x:Bind ViewModel.eps}" 
                  Padding="10,5,10,45"
                  ItemTemplate="{StaticResource EpTemplate}">
            <GridView.Header>
                <StackPanel Orientation="Vertical" >
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Image x:Name="BangumiImage" 
                               Source="{x:Bind ViewModel.ImageSource, Mode=OneWay}"/>
                        <StackPanel Orientation="Vertical" 
                                    Grid.Column="1"
                                    Margin="10,0">
                            <TextBlock Name="NameTextBlock" 
                                       IsTextSelectionEnabled="True"
                                       Text="{x:Bind ViewModel.Name_cn, Mode=OneWay}"
                                       TextWrapping="Wrap"
                                       Foreground="#d26585" />
                            <TextBlock Name="air_dateTextBlock" 
                                       Text="{x:Bind sys:String.Format('开播时间：{0}',ViewModel.Air_date), Mode=OneWay}" 
                                       Foreground="#666666" 
                                       Margin="0,2,0,0" />
                            <TextBlock Name="air_weekdayTextBlock" 
                                       Text="{x:Bind sys:String.Format('更新时间：{0}',ViewModel.AirWeekdayName), Mode=OneWay}" 
                                       Foreground="#666666" 
                                       Margin="0,2,0,0" />
                        </StackPanel>
                    </Grid>
                    <TextBlock Name="SummaryTextBlock" 
                               Text="{x:Bind ViewModel.Summary, Mode=OneWay}"
                               IsTextSelectionEnabled="True"
                               TextWrapping="Wrap" 
                               Margin="0,5,0,0" />
                    <HyperlinkButton Name="MoreInfoHyperLink"
                                     Content="更多资料"
                                     Click="MoreInfoButton_Click"
                                     Visibility="{x:Bind common:Converters.CollapsedIf(ViewModel.IsDetailLoading), Mode=OneWay}"
                                     FontSize="16"
                                     Foreground="#d26585"/>
                </StackPanel>
            </GridView.Header>
            <GridView.ItemContainerTransitions>
                <TransitionCollection>
                    <RepositionThemeTransition IsStaggeringEnabled="False" />
                </TransitionCollection>
            </GridView.ItemContainerTransitions>
        </GridView>

        <ProgressBar Name="MyProgressBar"
                     Grid.Row="1"
                     Visibility="{x:Bind ViewModel.IsUpdating, Mode=OneWay}"
                     IsIndeterminate="True"
                     VerticalAlignment="Top"/>

        <Border Name="MyWidth"
                Visibility="Collapsed"/>

    </Grid>
</Page>
